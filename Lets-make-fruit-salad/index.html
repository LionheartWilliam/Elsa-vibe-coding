<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Make Fruit Salad Game</title>
    <style>
        /* General Styles */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0fff0; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .game-container { width: 90%; max-width: 800px; background: #fff; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 25px; text-align: center; }
        h1, h2 { color: #2E8B57; }
        p.instructions { color: #555; font-size: 1.1em; }
        /* Button Styles */
        .btn { background-color: #3CB371; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: background-color 0.3s; margin: 10px; }
        .btn:hover { background-color: #2E8B57; }
        .btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        /* Game Card & Container Styles */
        .card { background-color: #f0fff0; border: 2px solid #98FB98; border-radius: 8px; padding: 15px; margin: 8px; cursor: grab; user-select: none; font-size: 1.1em; text-align: left; transition: background-color 0.3s, border-color 0.3s; }
        .card:active { cursor: grabbing; }
        .drop-container { background-color: #fafafa; border: 2px dashed #ccc; border-radius: 10px; padding: 10px; margin-top: 20px; min-height: 100px; }
        .feedback-area { margin-top: 15px; font-size: 1.2em; font-weight: bold; min-height: 30px; }
        /* State Colors */
        .correct { background-color: #d4edda; border-color: #c3e6cb; }
        .incorrect { background-color: #f8d7da; border-color: #f5c6cb; }
        /* Stage 2 Specific Styles */
        #stage2 .matching-area { display: flex; justify-content: space-between; margin-top: 20px; }
        #stage2 .column { width: 48%; display: flex; flex-direction: column; }
        #stage2 .match-pair { display: flex; align-items: center; margin-bottom: 10px; }
        #stage2 .chinese-card { flex: 1; }
        #stage2 .english-dropzone { flex: 1; min-height: 60px; background-color: #f0f0f0; border: 2px dashed #ddd; border-radius: 8px; margin-left: 10px; }
        /* Utility */
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="game-container">
        <h1>Let's Make Fruit Salad</h1>

        <div id="stage1">
            <h2>Stage 1: Story Sequencing</h2>
            <p class="instructions">Please listen to the story, then drag the sentences below into the grey box in the correct order.</p>
            <audio controls src="audio.mp3"></audio>
            <div id="target-container" class="drop-container"></div>
            <div id="source-container" class="drop-container"></div>
            <div id="feedback-stage1" class="feedback-area"></div>
            <button id="submit-stage1" class="btn">Submit</button>
            <button id="next-stage-btn" class="btn hidden">Go to Stage 2</button>
        </div>

        <div id="stage2" class="hidden">
            <h2>Stage 2: Chinese-English Matching</h2>
            <p class="instructions">Drag the English sentences from the right column to the box next to the matching Chinese meaning on the left.</p>
            <div class="matching-area">
                <div id="chinese-container" class="column"></div>
                <div id="english-container" class="column drop-container"></div>
            </div>
            <div id="feedback-stage2" class="feedback-area"></div>
            <button id="submit-stage2" class="btn">Submit</button>
        </div>
    </div>

    <script>
        // --- Game Data for "Let's Make Fruit Salad" ---
        const storySentences = [
            "Let's make fruit salad.", "Let's wash our hands first.", "How many oranges do we need?",
            "We need six oranges.", "Save the peel, Jello. We can make orange peel cleaner.",
            "So many grapes! How many grapes do we need?", "We need a lot.", "I like grapes.",
            "Boka, are you okay?", "Phew, that was close.", "Be careful next time, Boka."
        ];
        const sentencePairs = [
            { ch: "我們來做水果沙拉吧。", en: "Let's make fruit salad." },
            { ch: "我們先洗手吧。", en: "Let's wash our hands first." },
            { ch: "我們需要多少顆柳橙？", en: "How many oranges do we need?" },
            { ch: "我們需要六顆柳橙。", en: "We need six oranges." },
            { ch: "Jello，把果皮留下來。我們可以製作柳橙皮清潔劑。", en: "Save the peel, Jello. We can make orange peel cleaner." },
            { ch: "好多葡萄喔！我們需要多少葡萄？", en: "So many grapes! How many grapes do we need?" },
            { ch: "我們需要很多。", en: "We need a lot." },
            { ch: "我喜歡葡萄。", en: "I like grapes." },
            { ch: "Boka，你還好嗎？", en: "Boka, are you okay?" },
            { ch: "呼，好險。", en: "Phew, that was close." },
            { ch: "Boka，下次要小心一點。", en: "Be careful next time, Boka." }
        ];

        // --- Generic Game Logic ---
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } return array; }
        const sourceContainer = document.getElementById('source-container');
        const targetContainer = document.getElementById('target-container');
        const submitStage1Btn = document.getElementById('submit-stage1');
        const nextStageBtn = document.getElementById('next-stage-btn');
        const feedbackStage1 = document.getElementById('feedback-stage1');
        let draggedItem = null;

        function initializeStage1() {
            const shuffledSentences = shuffleArray([...storySentences]);
            shuffledSentences.forEach((sentence, index) => { const card = document.createElement('div'); card.id = `s1-card-${index}`; card.className = 'card'; card.textContent = sentence; card.draggable = true; sourceContainer.appendChild(card); });
            [sourceContainer, targetContainer].forEach(container => {
                container.addEventListener('dragstart', (e) => { if (e.target.classList.contains('card')) { draggedItem = e.target; setTimeout(() => e.target.style.opacity = '0.5', 0); } });
                container.addEventListener('dragend', () => { if (draggedItem) { setTimeout(() => { draggedItem.style.opacity = '1'; draggedItem = null; }, 0); } });
                container.addEventListener('dragover', (e) => { e.preventDefault(); });
                container.addEventListener('drop', (e) => { e.preventDefault(); if (e.currentTarget.classList.contains('drop-container') && draggedItem) { e.currentTarget.appendChild(draggedItem); } });
            });
        }

        submitStage1Btn.addEventListener('click', () => {
            const userOrderCards = Array.from(targetContainer.children);
            let allCorrect = userOrderCards.length === storySentences.length;
            userOrderCards.forEach((card, index) => { card.classList.remove('correct', 'incorrect'); if (storySentences[index] === card.textContent) { card.classList.add('correct'); } else { card.classList.add('incorrect'); allCorrect = false; } });
            if (allCorrect) { feedbackStage1.textContent = 'Great! All correct!'; feedbackStage1.style.color = 'green'; nextStageBtn.classList.remove('hidden'); submitStage1Btn.disabled = true; } else { feedbackStage1.textContent = 'Something is not right. Please check the red cards and try again!'; feedbackStage1.style.color = 'red'; }
        });

        nextStageBtn.addEventListener('click', () => {
            document.getElementById('stage1').classList.add('hidden');
            document.getElementById('stage2').classList.remove('hidden');
            initializeStage2();
        });

        const chineseContainer = document.getElementById('chinese-container');
        const englishContainer = document.getElementById('english-container');
        const submitStage2Btn = document.getElementById('submit-stage2');
        const feedbackStage2 = document.getElementById('feedback-stage2');

        function initializeStage2() {
            sentencePairs.forEach((pair) => { const pairContainer = document.createElement('div'); pairContainer.className = 'match-pair'; const chineseCard = document.createElement('div'); chineseCard.className = 'card chinese-card'; chineseCard.textContent = pair.ch; const englishDropzone = document.createElement('div'); englishDropzone.className = 'english-dropzone'; englishDropzone.dataset.correctEn = pair.en; pairContainer.appendChild(chineseCard); pairContainer.appendChild(englishDropzone); chineseContainer.appendChild(pairContainer); });
            const shuffledEnglish = shuffleArray([...sentencePairs]);
            shuffledEnglish.forEach((pair) => { const englishCard = document.createElement('div'); englishCard.className = 'card'; englishCard.textContent = pair.en; englishCard.draggable = true; englishContainer.appendChild(englishCard); });
            
            // ***** DRAG AND DROP LOGIC FIX STARTS HERE *****
            document.addEventListener('dragstart', e => {
                // MODIFIED: Now, ANY English card can be dragged, not just the ones in the right-hand container.
                if (e.target.classList.contains('card') && !e.target.classList.contains('chinese-card')) {
                    draggedItem = e.target;
                    setTimeout(() => e.target.style.opacity = '0.5', 0); // Visual feedback when dragging
                }
            });

            document.addEventListener('dragend', () => {
                if (draggedItem) {
                    setTimeout(() => {
                        draggedItem.style.opacity = '1';
                        draggedItem = null;
                    }, 0);
                }
            });

            document.addEventListener('dragover', e => e.preventDefault());
            
            document.addEventListener('drop', e => {
                e.preventDefault();
                const dropTarget = e.target;
                if (!draggedItem) return;

                // Logic for dropping into a dropzone
                if (dropTarget.classList.contains('english-dropzone')) {
                    // If the dropzone is already occupied, swap the cards
                    if (dropTarget.children.length > 0) {
                        const existingCard = dropTarget.firstChild;
                        englishContainer.appendChild(existingCard); // Move existing card back to the bank
                    }
                    dropTarget.appendChild(draggedItem);
                } 
                // Logic for dropping back into the main English container
                else if (dropTarget.id === 'english-container' || dropTarget.closest('#english-container')) {
                    englishContainer.appendChild(draggedItem);
                }
            });
            // ***** DRAG AND DROP LOGIC FIX ENDS HERE *****
        }
        
        submitStage2Btn.addEventListener('click', () => {
            const pairs = chineseContainer.querySelectorAll('.match-pair');
            let allCorrect = true;
            pairs.forEach(pair => {
                const dropzone = pair.querySelector('.english-dropzone');
                const droppedCard = dropzone.querySelector('.card');
                pair.classList.remove('correct', 'incorrect');
                if (droppedCard && dropzone.dataset.correctEn === droppedCard.textContent) {
                    pair.classList.add('correct');
                } else {
                    pair.classList.add('incorrect');
                    allCorrect = false;
                }
            });
            if (allCorrect) {
                feedbackStage2.textContent = 'Congratulations, you have completed the game!';
                feedbackStage2.style.color = 'green';
                submitStage2Btn.disabled = true;
            } else {
                feedbackStage2.textContent = 'Some pairs are incorrect. Please try again!';
                feedbackStage2.style.color = 'red';
            }
        });
        
        initializeStage1();
    </script>
</body>
</html>